---
title: "Check consent"
---

# Purpose

The consent data set does not contain all of the MedStar IDs that are contained in the other data sets downloaded from FileMaker Pro. The purpose of the code in this file is to inventory the MedStar IDs that are not found in the consent data set and make sure they shouldn't be included in the count of DETECT follow up interviews completed.


# Load Packages

```{r}
library(dplyr, warn.conflicts = FALSE)
library(purrr)
```

# Load data

Load the data table into the global environment as a data frame using the raw csv file. See this Wiki page for more information about the location of the data: https://github.com/brad-cannell/detect_fu_interviews_public/wiki. 

```{r}
names_paths <- c(
  "aps" = "aps_investigations_import.rds",
  "con" = "consent_import.rds",
  "cls" = "clutter_scale_import.rds",
  "glh" = "general_health_import.rds",
  "lpa" = "lead_panel_assessment_import.rds",
  "obs" = "observational_measures_import.rds",
  "par" = "participant_import.rds",
  "sfr" = "self_report_import.rds",
  "soc" = "sociodemographic_information_import.rds",
  "detect_fu_data_merged" = "detect_fu_data_merged.rds"
)
```

```{r}
#| message: false

iwalk(
  names_paths,
  # When using iwalk with an anonymous function as we do below, .x refers to 
  # the element of the vector passed to the .x argument and .y refers to the
  # index. When we pass a named vector to the .x argument, then the index is
  # The element's name.
  ~ {
    # Get the path for the current data set
    path <- here::here("data", "cleaned_rds_files", .x)
    # Get the data
    df <- readr::read_rds(path)
    # Print the dimensions of the data for future data checks
    cat(.y, ":", dim(df), "\n")
    # Assign the data to the global environment
    assign(.y, df, envir = globalenv())
  }
)

# aps : 951 26 
# con : 1013 17 
# cls : 893 29 
# glh : 955 105 
# lpa : 6838 38 
# obs : 935 132 
# par : 92160 84 
# sfr : 955 574 
# soc : 963 52 
# detect_fu_data_merged : 98200 799 

# These may change over time if we modify the data. Because we are only checking 
# MedStar IDs in this file, changes to the number of columns are not likely to 
# matter much. Changes to the number of rows may or may not be important.
```


# Create a list of data frame names

Create a list of data frame names that we will iterate over below. The list should include all of the data frames in `names_paths` except `detect_fu_data_merged`.

```{r}
df_names <- names(names_paths)
df_names <- df_names[df_names != "detect_fu_data_merged"]
```

```{r}
# No longer need names_paths
rm(names_paths)
```


# List all MedStar IDs

Create a named list containing the unique MedStar IDs that are present in each of the cleaned data frames.

```{r}
medstar_ids_list <- map(
  df_names,
  ~ get(.x)[["medstar_id"]] |> unique()
) |> 
  set_names(df_names)
```


# List missing MedStar IDs

Create named list containing all of the MedStar IDs that exist in each of the follow-up interview data frames, but do not exist in the consent data frame.

```{r}
medstar_ids_not_in_con <- map(
  df_names,
  ~ setdiff(medstar_ids_list[[.x]], medstar_ids_list[["con"]])
) |> 
  set_names(df_names)
```

Convert the list of MedStar IDs to a data frame that is easier to work with. 
- The first column will contain the name of the data frame that contains the MedStar ID.
- The second column will contain the MedStar ID that wasn't found in the consent data frame.
- We will drop all rows from the participant data frame (`par`). Most of those encounters did not receive a follow-up interview by design.

```{r}
medstar_ids_not_in_con <- medstar_ids_not_in_con |> 
  stack() |> 
  select(df = ind, medstar_id = values) |> 
  filter(df != "par")
```


# Check for error messages

For each MedStar ID listed in `medstar_ids_not_in_con`, we will check the follow-up data sets for an error message. If one exists, we will append it to `medstar_ids_not_in_con`.

First, create a named list of data frames. Each data frame contains `medstar_id` `x_error_message` only. Below, we will join these error messages to the MedStar IDs in `medstar_ids_not_in_con`.

```{r}
error_messsages <- map(
  df_names,
  ~ get(.x)[, c("medstar_id", "x_error_message")]
) |> 
  set_names(df_names)
```

Convert the list of data frames into a single data frame.
- We will drop all rows from the participant data frame (`par`). Most of those encounters did not receive a follow-up interview by design.

```{r}
error_messsages <- bind_rows(error_messsages, .id = "df") |> 
  filter(df != "par")
```

Filter `error_messsages` to only include rows with MedStar IDs that are also in `medstar_ids_not_in_con`.

```{r}
error_messsages <- error_messsages |> 
  filter(medstar_id %in% medstar_ids_not_in_con$medstar_id)
```

Filter `error_messsages` to only include rows that don't have a "Participant consent not recorded" error associated with their record in the follow-up instrument data frame.

```{r}
error_messages <- error_messsages |> 
  filter(x_error_message != "Participant consent not recorded" | is.na(x_error_message))
```


# ðŸ”´ Left off here
- Trying to recreate Ebie's results.
- Need to just finish checking for error messages.
- Her code is returning two rows. My code is returning 4 rows.


```{r}
# For comparing to Ebie's results
check_error_message |> filter(medstar_id %in% error_messages$medstar_id)
```






# ðŸ”´ Ebie's code 
- Trying to recreate Ebie's results.

```{r}
# Check participant consent in the other data sets
check_error_message <- detect_fu_data_merged %>%
  filter(medstar_id %in% medstar_ids_not_in_con$medstar_id) %>%
  select(c(medstar_id, contains("x_error_message"))) %>%
  left_join(medstar_ids_not_in_con, by = "medstar_id")

check_error_message
```

```{r}
# Filter MedStar IDs that don't have the error message "Participant consent not recorded" for any of the datasets
no_error <- check_error_message %>% filter(if_all(contains("x_error_message"), ~ is.na(.) == T))
no_error
```

Two of the 13 MedStar IDs don't have the error message "Participant consent not recorded" for any of the datasets.
Both medstar_ids are in the observational measures data set.

```{r}
# check the status of these medStar IDs in the observational measures dataset
check_obs <- detect_fu_data_merged %>%
  filter(medstar_id %in% no_error$medstar_id) %>%
  select(x_record_status_obs)
check_obs
```
Both have incomplete status. 

# Conclusion
None of the MedStar IDs not found in the consent data set need to be included in the count of DETECT follow up interviews completed.
