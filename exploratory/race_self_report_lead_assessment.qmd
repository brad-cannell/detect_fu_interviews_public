---
title: "Race Interactions with Abuse"
format: html
---

# Load packages
```{r, warning=FALSE, echo=FALSE, output = FALSE}
library(flextable)
library(table1)
library(dplyr)
library(tibble)
library(misty)
library(mice)
library(officer)
library(tidyverse)
library(plyr)
```

# Load cleaned data

Load the participant, self report, LEAD panel assessment and sociodemographic information datasets

```{r}
#| warning: false
sociodemographic_information_import.rds <- file.choose()
socio_demo <- readRDS(sociodemographic_information_import.rds)

self_report_import.rds <- file.choose()
self_report <- readRDS(self_report_import.rds)

lead_panel_assessment_import.rds <- file.choose()
lead_panel_assessment <- readRDS(lead_panel_assessment_import.rds)
```

# Data preparation

Prepare and then merge the relevant variables in the self report, LEAD panel assessment and sociodemographic information data sets into one data frame.

## Sociodemographic Information
```{r}
# select relevant variables from sociodemographic information df
soc_dem <- socio_demo %>%
  select(medstar_id, sode_hispanic_4cat_f, sode_race) %>% drop_na(-c("sode_hispanic_4cat_f"))

# create dummy variables for race
soc_dem <- soc_dem %>% 
  mutate(
    american_indian_or_alaska_native = str_detect(sode_race, "American Indian or Alaska Native"),
    asian = str_detect(sode_race, "Asian"),
    black_or_african_american = str_detect(sode_race, "Black or African American"),
    native_hawaiian_or_other_pacific_islander = str_detect(sode_race, "Native Hawaiian or Other Pacific Islander"),
    white = str_detect(sode_race, "White"),
    other = str_detect(sode_race, "Other")
  )

```

## LEAD Panel Assessment

```{r}
# select relevant variables from LEAD panel assessment df
lpa <- lead_panel_assessment %>%
  select(c(11, 19:28))
```

```{r}

# Create dummy variables
lpa <- lpa %>%
  mutate(
    physical_abuse_2cat = case_when(
      physical_abuse_2cat_f == "No"   ~ 0,
      physical_abuse_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    sexual_abuse_2cat = case_when(
      sexual_abuse_2cat_f == "No"   ~ 0,
      sexual_abuse_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    emotional_psycho_abuse_2cat = case_when(
      emotional_psycho_abuse_2cat_f == "No"   ~ 0,
      emotional_psycho_abuse_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    neglect_2cat = case_when(
      neglect_2cat_f == "No"   ~ 0,
      neglect_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    abandonment_2cat = case_when(
      abandonment_2cat_f == "No"   ~ 0,
      abandonment_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    financial_exploitation_2cat = case_when(
      financial_exploitation_2cat_f == "No"   ~ 0,
      financial_exploitation_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    self_neglect_2cat = case_when(
      self_neglect_2cat_f == "No"   ~ 0,
      self_neglect_2cat_f == "Yes"  ~ 1
    )
  )

lpa <- lpa %>%
  mutate(
    xc_assessment_screened_2cat = case_when(
      xc_assessment_screened_2cat_f == "Negative"  ~ 0,
      xc_assessment_screened_2cat_f == "Positive"  ~ 1
    )
  )
```

```{r}
# subset with initial assessment only
initial <- lpa %>% filter(assessment_type_3cat_f == "Initial assessment")

# subset with Secondary assessment only
secondary <- lpa %>% filter(assessment_type_3cat_f == "Secondary assessment")

# subset with Post-detect assessment only
post_detect <- lpa %>% filter(assessment_type_3cat_f == "Post-detect assessment")
```

```{r}
# create columns with proportion of positive abuse (count of positive votes/#of voters) determinations for each medstar_id
initial <- initial %>%
  group_by(medstar_id) %>%
  reframe(
    physical_abuse_all = ifelse(sum(physical_abuse_2cat) == 0, 0, sum(physical_abuse_2cat)/ n()),
    
    sexual_abuse_all = ifelse(sum(sexual_abuse_2cat) == 0, 0, sum(sexual_abuse_2cat)/n()),
                              
    emotional_psycho_abuse_all = ifelse(sum(emotional_psycho_abuse_2cat) == 0, 0, sum(emotional_psycho_abuse_2cat)/ n()),
                                        
    neglect_all = ifelse(sum(neglect_2cat) == 0, 0, sum(neglect_2cat)/ n()),
                         
    abandonment_all = ifelse(sum(abandonment_2cat) == 0, 0, sum(abandonment_2cat)/ n()),
    
    financial_exploitation_all = ifelse(sum(financial_exploitation_2cat) == 0, 0, sum(financial_exploitation_2cat)/ n()),
    
    self_neglect_all = ifelse(sum(self_neglect_2cat) == 0, 0, sum(self_neglect_2cat)/ n()),
    xc_assessment_screened_all = ifelse(sum(xc_assessment_screened_2cat) == 0, 0, sum(xc_assessment_screened_2cat)/ n()),
    medstar_id = unique(medstar_id),
    assessment_type_3cat_f = unique(assessment_type_3cat_f)
    )

secondary <- secondary %>%
  group_by(medstar_id) %>%
  reframe(
    physical_abuse_all = ifelse(sum(physical_abuse_2cat) == 0, 0, sum(physical_abuse_2cat)/ n()),
    
    sexual_abuse_all = ifelse(sum(sexual_abuse_2cat) == 0, 0, sum(sexual_abuse_2cat)/n()),
                              
    emotional_psycho_abuse_all = ifelse(sum(emotional_psycho_abuse_2cat) == 0, 0, sum(emotional_psycho_abuse_2cat)/ n()),
                                        
    neglect_all = ifelse(sum(neglect_2cat) == 0, 0, sum(neglect_2cat)/ n()),
                         
    abandonment_all = ifelse(sum(abandonment_2cat) == 0, 0, sum(abandonment_2cat)/ n()),
    
    financial_exploitation_all = ifelse(sum(financial_exploitation_2cat) == 0, 0, sum(financial_exploitation_2cat)/ n()),
    
    self_neglect_all = ifelse(sum(self_neglect_2cat) == 0, 0, sum(self_neglect_2cat)/ n()),
    xc_assessment_screened_all = ifelse(sum(xc_assessment_screened_2cat) == 0, 0, sum(xc_assessment_screened_2cat)/ n()),
    medstar_id = unique(medstar_id),
    assessment_type_3cat_f = unique(assessment_type_3cat_f)
    )

post_detect <- post_detect %>%
  group_by(medstar_id) %>%
  reframe(
    physical_abuse_all = ifelse(sum(physical_abuse_2cat) == 0, 0, sum(physical_abuse_2cat)/ n()),
    
    sexual_abuse_all = ifelse(sum(sexual_abuse_2cat) == 0, 0, sum(sexual_abuse_2cat)/n()),
                              
    emotional_psycho_abuse_all = ifelse(sum(emotional_psycho_abuse_2cat) == 0, 0, sum(emotional_psycho_abuse_2cat)/ n()),
                                        
    neglect_all = ifelse(sum(neglect_2cat) == 0, 0, sum(neglect_2cat)/ n()),
                         
    abandonment_all = ifelse(sum(abandonment_2cat) == 0, 0, sum(abandonment_2cat)/ n()),
    
    financial_exploitation_all = ifelse(sum(financial_exploitation_2cat) == 0, 0, sum(financial_exploitation_2cat)/ n()),
    
    self_neglect_all = ifelse(sum(self_neglect_2cat) == 0, 0, sum(self_neglect_2cat)/ n()),
    xc_assessment_screened_all = ifelse(sum(xc_assessment_screened_2cat) == 0, 0, sum(xc_assessment_screened_2cat)/ n()),
    medstar_id = unique(medstar_id),
    assessment_type_3cat_f = unique(assessment_type_3cat_f)
    )
```

```{r}
# create factor variables for final determination
# Final determination will be by majority vote of the secondary assessment (if one was done) or initial assessment (if a secondary assessment wasn't done)

initial <- initial %>%
  mutate(
    physical_abuse_det = case_when(
      physical_abuse_all <= 0.5  ~ 0,
      physical_abuse_all > 0.5   ~ 1
    ),
    sexual_abuse_det = case_when(
      sexual_abuse_all<= 0.5  ~ 0,
      sexual_abuse_all > 0.5  ~ 1
    ),
    emotional_psycho_abuse_det = case_when(
      emotional_psycho_abuse_all<= 0.5  ~ 0,
      emotional_psycho_abuse_all > 0.5  ~ 1
    ),
    neglect_det = case_when(
      neglect_all<= 0.5  ~ 0,
      neglect_all > 0.5  ~ 1
    ),
    abandonment_det = case_when(
      abandonment_all<= 0.5  ~ 0,
      abandonment_all > 0.5  ~ 1
    ),
    financial_exploitation_det = case_when(
      financial_exploitation_all<= 0.5  ~ 0,
      financial_exploitation_all > 0.5  ~ 1
    ),
    self_neglect_det = case_when(
      self_neglect_all<= 0.5  ~ 0,
      self_neglect_all > 0.5  ~ 1
    ),
    xc_assessment_screened_det = case_when(
      xc_assessment_screened_all<= 0.5  ~ 0,
      xc_assessment_screened_all > 0.5  ~ 1
    )
  )

secondary <- secondary %>%
  mutate(
    physical_abuse_det = case_when(
      physical_abuse_all<= 0.5  ~ 0,
      physical_abuse_all > 0.5  ~ 1
    ),
    sexual_abuse_det = case_when(
      sexual_abuse_all<= 0.5  ~ 0,
      sexual_abuse_all > 0.5  ~ 1
    ),
    emotional_psycho_abuse_det = case_when(
      emotional_psycho_abuse_all<= 0.5  ~ 0,
      emotional_psycho_abuse_all > 0.5  ~ 1
    ),
    neglect_det = case_when(
      neglect_all<= 0.5  ~ 0,
      neglect_all > 0.5  ~ 1
    ),
    abandonment_det = case_when(
      abandonment_all<= 0.5  ~ 0,
      abandonment_all > 0.5  ~ 1
    ),
    financial_exploitation_det = case_when(
      financial_exploitation_all<= 0.5  ~ 0,
      financial_exploitation_all > 0.5  ~ 1
    ),
    self_neglect_det = case_when(
      self_neglect_all<= 0.5  ~ 0,
      self_neglect_all > 0.5  ~ 1
    ),
    xc_assessment_screened_det = case_when(
      xc_assessment_screened_all<= 0.5  ~ 0,
      xc_assessment_screened_all > 0.5  ~ 1
    )
  )

post_detect <- post_detect %>%
  mutate(
    physical_abuse_det = case_when(
      physical_abuse_all<= 0.5  ~ 0,
      physical_abuse_all > 0.5  ~ 1
    ),
    sexual_abuse_det = case_when(
      sexual_abuse_all<= 0.5  ~ 0,
      sexual_abuse_all > 0.5  ~ 1
    ),
    emotional_psycho_abuse_det = case_when(
      emotional_psycho_abuse_all<= 0.5  ~ 0,
      emotional_psycho_abuse_all > 0.5  ~ 1
    ),
    neglect_det = case_when(
      neglect_all<= 0.5  ~ 0,
      neglect_all > 0.5  ~ 1
    ),
    abandonment_det = case_when(
      abandonment_all<= 0.5  ~ 0,
      abandonment_all > 0.5   ~ 1
    ),
    financial_exploitation_det = case_when(
      financial_exploitation_all<= 0.5  ~ 0,
      financial_exploitation_all > 0.5  ~ 1
    ),
    self_neglect_det = case_when(
      self_neglect_all<= 0.5  ~ 0,
      self_neglect_all > 0.5  ~ 1
    ),
    xc_assessment_screened_det = case_when(
      xc_assessment_screened_all<= 0.5  ~ 0,
      xc_assessment_screened_all > 0.5  ~ 1
    )
  )


# Make columns factor variables

cols <- c("physical_abuse_det", "sexual_abuse_det", "emotional_psycho_abuse_det", "neglect_det", "abandonment_det", "financial_exploitation_det", "self_neglect_det", "xc_assessment_screened_det")

initial[cols] <- lapply(initial[cols], factor)
secondary[cols] <- lapply(secondary[cols], factor)


```

```{r}
# Merge the initial and secondary data sets, keeping only the secondary for each medstar_id when it is available
final_determination <- initial[!initial$medstar_id %in% secondary$medstar_id,]
final_determination <- rbind(final_determination, secondary)
```

## Merge sociodemographic and LEAD dateframes

```{r}
# Merge subset dfs into a new df

final_determination <- left_join(final_determination, soc_dem) %>% 
filter(
    if_all(
      everything(), ~ !grepl(paste(c("Refused", "Don't know"), collapse='|'),.)
      )
  )%>% droplevels()%>% 
  drop_na()

```

# Analaysis

## Create descriptive tables by race

### Hispanic

```{r}
# Create caption/ title
cap_1  <- "Frequency Table for Abuse Determination by Ethnicity (Hispanic)"


his_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | sode_hispanic_4cat_f, 
               data = final_determination, 
               caption = cap_1)
his_tab <- t1flex(his_tab, tablefn = c("qflextable", "flextable", "regulartable"))
his_tab <- width(his_tab, width = 3)
his_tab
```

### american_indian_or_alaska_native

```{r}
# Create caption/ title
cap_2  <- "Frequency Table for Abuse Determination by race (American Indian or Alsaska Native)"


nat_ame_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | american_indian_or_alaska_native, 
               data = final_determination, 
               caption = cap_2)
nat_ame_tab <- t1flex(nat_ame_tab, tablefn = c("qflextable", "flextable", "regulartable"))
nat_ame_tab <- width(nat_ame_tab, width = 3)
nat_ame_tab
```


### asian

```{r}
# Create caption/ title
cap_3  <- "Frequency Table for Abuse Determination by Race (Asian)"


asian_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | asian, 
               data = final_determination, 
               caption = cap_3)
asian_tab <- t1flex(asian_tab, tablefn = c("qflextable", "flextable", "regulartable"))
asian_tab <- width(asian_tab, width = 3)
asian_tab
```

	
### black_or_african_american

```{r}
# Create caption/ title
cap_4  <- "Frequency Table for Abuse Determination by Race (Black or African American)"


black_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | black_or_african_american, 
               data = final_determination, 
               caption = cap_4)
black_tab <- t1flex(black_tab, tablefn = c("qflextable", "flextable", "regulartable"))
black_tab <- width(black_tab, width = 3)
black_tab
```

### native_hawaiian_or_other_pacific_islander

```{r}
cap_5  <- "Frequency Table for Abuse Determination by Race (Native Hawaiian or Other Pacific Islander)"


nat_haw_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | 	
native_hawaiian_or_other_pacific_islander, 
               data = final_determination, 
               caption = cap_5)
nat_haw_tab <- t1flex(nat_haw_tab, tablefn = c("qflextable", "flextable", "regulartable"))
nat_haw_tab <- width(nat_haw_tab, width = 3)
nat_haw_tab
```

### white

```{r}
cap_6  <- "Frequency Table for Abuse Determination by Race (White)"


white_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | 	
white, 
               data = final_determination, 
               caption = cap_6)
white_tab <- t1flex(white_tab, tablefn = c("qflextable", "flextable", "regulartable"))
white_tab <- width(white_tab, width = 3)
white_tab
```

### other

```{r}
cap_7  <- "Frequency Table for Abuse Determination by Race (Other)"


other_tab <- table1(~ physical_abuse_det + sexual_abuse_det + emotional_psycho_abuse_det + neglect_det + abandonment_det + financial_exploitation_det + self_neglect_det + xc_assessment_screened_det | 	
other, 
               data = final_determination, 
               caption = cap_7)
other_tab <- t1flex(other_tab, tablefn = c("qflextable", "flextable", "regulartable"))
other_tab <- width(other_tab, width = 3)
other_tab
```

