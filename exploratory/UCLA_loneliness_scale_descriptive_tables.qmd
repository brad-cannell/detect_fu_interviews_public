---
title: "DETECT Data Descriptive Tables"
format: html
---

# Load packages
```{r, warning=FALSE}
library(flextable)
library(table1)
library(dplyr)
library(tibble)
library(misty)
library(mice)
library(officer)
library(tidyverse)
library(here)
library(fastLink)
library(lubridate)
```

## Load cleaned data

Load the general health and participant datasets

```{r}
#| warning: false
general_health_import.rds <- file.choose()
general_health <- readRDS(general_health_import.rds)

participant_import.rds <- file.choose()
participant <- readRDS(participant_import.rds)

sociodemographic_information_import.rds <- file.choose()
soc_dem <- readRDS(sociodemographic_information_import.rds)
```

# Create Word Document

```{r}
# create empty Word file
detect_doc <- read_docx()

# Add title
body_add_title(
  detect_doc,
  "DETECT Data Summary",
  level = 1,
  squish = TRUE,
)

# Add UCLA ls tables
detect_doc <- detect_doc %>% 
  body_add_par("UCLA Loneliness Scale Data", style = "heading 2") %>%
  body_add_par("There are 376 rows with completed UCLA loneliness scale data and 563 rows with at least one item missing.")%>%
  body_add_flextable(ls_m)%>%
  body_add_par("The table shows the counts for unique people while excluding rows with at least one missing UCLA scale item.")%>%
  body_add_flextable(sum_table)%>%
  body_add_par("The tables show the summary statistics for the the UCLA three item scale while excluding rows with at least one missing UCLA scale item as well as rows where response to any item question was refused.")%>%
  body_add_flextable(ls_c)%>%
  body_add_flextable(ls_s)%>%
  body_add_flextable(ls_t)

# Add Sociodemographic Information tables
detect_doc <- detect_doc %>% 
  body_add_par("Sociodemographic Information Data", style = "heading 2") %>%
  body_add_par("The table below shows the frequencies of categorical variables in the sociodemograhic Information dataset while excluding rows where items in the UCLA loneliness scale were either missing or had a response of 'Refused'.")%>%
  body_add_flextable(sdls_tab)%>%
  body_add_par("The table below shows the central tendency and variation measures for some numerically coded sociodemographic information variables while excluding rows where items in the UCLA loneliness scale were either missing or had a response of 'Refused'. Additionally, rows that had 'Refused' and 'Don't know' responses for the sociodemographic information variables were filtered out.")%>%
  body_add_flextable(sdls_tab_n)

  

 
```

#UCLA loneliness scale

## Missing data summary

Create table that summarizes missing data using the md.pattern function 

```{r, fig.width = 12}
ls_m <- general_health %>% 
  select(
    starts_with("ls") & ends_with("4cat_f") 
    )%>% md.pattern(., plot = F, rotate.names = T)

ls_m <-ls_m %>% as.data.frame() %>% 
  rownames_to_column() %>% 
  rename(No_of_rows = rowname, 
         ls_lack_companionship = ls_lack_companionship_4cat_f,
         ls_feel_left_out = ls_feel_left_out_4cat_f,
         ls_feel_isolated = ls_feel_isolated_4cat_f,
         No_missing_per_row= V4) %>% 
  flextable()

ls_m <- add_footer_row(ls_m,
  values = c("A matrix with ncol(x)+1 columns, in which each row corresponds to a missing data pattern (1 = observed, 0 = missing). Rows and columns are sorted in increasing amounts of missing information. The last column and row contain row and column counts, respectively."),
  colwidths = c(5), top = TRUE
  )

ls_m <- align(ls_m, align = "left", part = "all")

ls_m <- bold(ls_m, bold = TRUE, i = 5, part = 'body')
ls_m <- bold(ls_m, bold = TRUE, j = 1, part = 'body')
ls_m <- bold(ls_m, bold = TRUE, j = 5, part = 'body')
ls_m <- set_caption(ls_m, "Missing Data Patterns")

ls_m
```

## Unique people count

Table that summarizes counts of unique people that completed the UCLA loneliness scale

### Prepare data 

Merge relevant variables from the participant and general health datasets into one dataset and separate certain variables for the unique value summary excluding missing rows

```{r}
part_id <- participant %>% 
  select(medstar_id, name_first, name_middle_initial, name_last, dob, sex, x_address_original)

# merge name columns into new full name column
part_id <- part_id %>% unite("name_full", 'name_first': 'name_last', sep = ' ', na.rm = TRUE, remove = F) %>% relocate(name_full, .after = name_last)

ls <- general_health %>% 
  select(medstar_id, x_record_month, x_record_year,
    starts_with("ls") & ends_with("4cat_f") 
    ) %>%
  drop_na(c('ls_lack_companionship_4cat_f', 'ls_feel_left_out_4cat_f', 'ls_feel_isolated_4cat_f' ))

gen_part <- left_join(ls, part_id)
gen_part <- gen_part %>% separate(x_address_original, into = c("house_number", "street_name"), sep = "^\\S*\\K\\s+")

```
### Create table
Table with counts of unique names and number of names that occur once or more than once excluding rows with missing data.

```{r, warning = FALSE}
# Unique people count

unique_people <- gen_part %>% select(name_first, name_last, dob, sex, house_number) %>% group_by_all() %>% summarise(count = n()) %>% unique()

# List of people whose names occur in only one row with complete ls scale data

ucs <- unique_people %>% filter(count == 1)

# People whose names occur in more than one row with complete ls scale data with the number of occurrences

nucs <- unique_people %>% filter(count > 1)

# Filtered dataset that includes only people that occur more than once 

nucs_df <- filter(gen_part, name_full %in% nucs$Name) 

# Table summarizing counts of unique names and number of names that occur once or more than once excluding rows with missing loneliness scale data

sum_table <- data.frame(Value = c("Unique people", "Occur multiple times", "Occur only once", "Total number of observations including people that occur multiple times"),
                        Count = c(nrow(unique_people), nrow(nucs), nrow(ucs), nrow(gen_part))) %>%
  flextable()
# Set caption

sum_table <- set_caption(sum_table, "Unique and Non-unique Name Counts")
  
sum_table
```

## Create descriptive tables

### Create subset dataset 

This subset includes the loneliness scale data and excludes missing and 'refused' responses

```{r}
#| echo: false
#| eval: true
lsd <- general_health %>% 
  select(
    starts_with("ls") & ends_with(c("4cat_f", "4cat"))
    )%>% 
  na.omit %>%
  filter(
    if_all(
      everything(), ~ !grepl(paste('Refused', collapse='|'),.)
      )
  )%>% droplevels()
```

### Create descriptive table for categorical data

```{r}
label(lsd$ls_lack_companionship_4cat_f)     <- "feel a lack of companionship"
label(lsd$ls_feel_left_out_4cat_f)          <- "feel left out"
label(lsd$ls_feel_isolated_4cat_f)          <- "feel isolated"
label(lsd$ls_lack_companionship_4cat)       <- "feel a lack of companionship"
label(lsd$ls_feel_left_out_4cat)            <- "feel left out"
label(lsd$ls_feel_isolated_4cat)            <- "feel isolated"


cap_c  <- "Basic Stats for UCLA Loneliness Scale"


ls_c <- table1(~ ls_lack_companionship_4cat_f + ls_feel_left_out_4cat_f + ls_feel_isolated_4cat_f, data = lsd, caption = cap_c)
ls_c <- t1flex(ls_c, tablefn = c("qflextable", "flextable", "regulartable"))

ls_c
```

### Create descriptive table for scores (Calculating the UCLA scale scores individually)

```{r}
cap_s  <- "Basic Stats for UCLA Loneliness Scale Numeric Scores (Individual)"


ls_s <- table1(~ ls_lack_companionship_4cat + ls_feel_left_out_4cat + ls_feel_isolated_4cat, data = lsd, caption = cap_s)
ls_s <- t1flex(ls_s, tablefn = c("qflextable", "flextable", "regulartable"))

ls_s <- add_footer_row(ls_s,
  values = c("1 = Hardly ever, 2 = Some of the time, 3 = Often"),
  colwidths = c(2), top = TRUE
  )
ls_s
```

### Create descriptive table for scores (Calculating the UCLA scale total score with SD)

```{r}
# Create column with total scores
lsd <- lsd %>% mutate(total_score = rowSums(.[1:3]))

# Create descriptive table
cap_t  <- "Basic Stats for UCLA Loneliness Scale Numeric Scores (Total)"


ls_t <- table1(~ total_score, data = lsd, caption = cap_t)
ls_t <- t1flex(ls_t, tablefn = c("qflextable", "flextable", "regulartable"))

ls_t
```

# Sociodemographic Information

## Prepare data
Create dataframe that includes requested socio-demographic information for rows that do not have any missing values or 'Refused' or 'Don't know responsed for loneliness scale data. 

```{r}
sdf <- soc_dem %>% 
  select(c(8,10:12,17:42)
  )
# Exclude 'Refused' responses for UCLA data
gen_part_r <- gen_part%>%
  filter(
    if_all(
      everything(), ~ !grepl(paste('Refused', collapse='|'),.)
      )
  )%>% droplevels()


soc_dem_ls <- left_join(gen_part_r, sdf)

# Exclude 'Refused' and 'Don't know' responses for all variables
pat = c("Don't know", "Refused")
soc_dem_ls_n <- soc_dem_ls_n %>% 
  filter(
    if_all(
      everything(), ~ !grepl(paste(pat, collapse='|'),.)
      )
  )%>% droplevels()%>%
  mutate(
    sode_age_years = as.numeric(sode_age_years), sode_people = as.numeric(sode_people)
  )
```
## Create descriptive tables

### Categorical data

```{r}

# Create variable labels
label(soc_dem_ls$sode_people_3cat_f)      <- "Household size"
label(soc_dem_ls$sode_race)               <- "Race"
label(soc_dem_ls$sode_marital_8cat_f)     <- "Marital status"
label(soc_dem_ls$sode_age_4cat_f)         <- "Age (group)"
label(soc_dem_ls$sode_hispanic_4cat_f)    <- "Hispanic"
label(soc_dem_ls$sode_school_9cat_f)      <- "Education"
label(soc_dem_ls$sode_employed_11cat_f)   <- "Employment status"
label(soc_dem_ls$sode_income_9cat_f)      <- "Household income"
label(soc_dem_ls$sode_military_4cat_f)    <- "Military status"
label(soc_dem_ls$sode_unwanted_4cat_f)    <- "Unwanted attention"
label(soc_dem_ls$sode_sexual_4cat_f)      <- "Sexual contact against will"
label(soc_dem_ls$sogi_identity_5cat_f)    <- "Gender identity"
label(soc_dem_ls$sogi_orientation_8cat_f) <- "Sexual orientation"
label(soc_dem_ls$hsi_contact_4cat_f)      <- "Future contact"

# Create caption/ title
cap_soc  <- "Basic Stats for Sociodemographic Information (Frequency)"


sdls_tab <- table1(~ sode_people_3cat_f + sode_race + sode_marital_8cat_f + sode_age_4cat_f + sode_hispanic_4cat_f + sode_school_9cat_f + sode_employed_11cat_f + sode_income_9cat_f + sode_military_4cat_f + sode_unwanted_4cat_f + sode_sexual_4cat_f + sogi_identity_5cat_f + sogi_orientation_8cat_f + hsi_contact_4cat_f, 
               data = soc_dem_ls, 
               caption = cap_soc)
sdls_tab <- t1flex(sdls_tab, tablefn = c("qflextable", "flextable", "regulartable"))

sdls_tab
```
### Numerically coded data


```{r}
# Create variable labels
label(soc_dem_ls_n$sode_people)             <- "Household size"
label(soc_dem_ls_n$sode_age_years)          <- "Age (years)"
label(soc_dem_ls_n$sode_age_4cat)           <- "Age (group)"
label(soc_dem_ls_n$sode_marital_8cat)       <- "Marital status"
label(soc_dem_ls_n$sode_hispanic_4cat)      <- "Hispanic"
label(soc_dem_ls_n$sode_school_9cat)        <- "Education"
label(soc_dem_ls_n$sode_employed_11cat)     <- "Employment status"
label(soc_dem_ls_n$sode_income_9cat)        <- "Household income"
label(soc_dem_ls_n$sode_military_4cat)      <- "Military status"
label(soc_dem_ls_n$sode_unwanted_4cat)      <- "Unwanted attention"
label(soc_dem_ls_n$sode_sexual_4cat)        <- "Sexual contact against will"
label(soc_dem_ls_n$sogi_identity_5cat)      <- "Gender identity"
label(soc_dem_ls_n$sogi_orientation_8cat)   <- "Sexual orientation"
label(soc_dem_ls_n$hsi_contact_4cat)        <- "Future contact"

cap_soc_n  <- "Basic Stats for Sociodemographic Information (Central tendency)"


sdls_tab_n <- table1(~ sode_age_years + sode_age_4cat + sode_people + sode_marital_8cat + sode_hispanic_4cat + sode_school_9cat + sode_employed_11cat + sode_income_9cat + sode_military_4cat + sode_unwanted_4cat + sode_sexual_4cat + sogi_identity_5cat + sogi_orientation_8cat + hsi_contact_4cat, 
               data = soc_dem_ls_n, 
               caption = cap_soc_n)
sdls_tab_n <- t1flex(sdls_tab_n, tablefn = c("qflextable", "flextable", "regulartable"))

sdls_tab_n
```

# General Health
## Prepare the data

```{r}
gh_ls <- general_health %>% 
  select(medstar_id, x_record_month, x_record_year,
    starts_with("ls") & ends_with("4cat_f") 
    ) %>%
  drop_na(c('ls_lack_companionship_4cat_f', 'ls_feel_left_out_4cat_f', 'ls_feel_isolated_4cat_f' ))
```









